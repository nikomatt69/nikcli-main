%%{init: {'theme':'neutral', 'themeVariables': { 'primaryColor': '#2196F3', 'primaryTextColor': '#000000', 'primaryBorderColor': '#1976D2', 'lineColor': '#1976D2', 'lineColorBackground': '#FFFFFF', 'secondaryColor': '#4CAF50', 'tertiaryColor': '#FFC107', 'fontFamily': 'Arial, sans-serif'}}}%%

flowchart TB
    %% Title
    title((NikCLI System Architecture v2.0))
    title --> entry

    %% CLI Entry Points - Professional Blue Theme
    subgraph entry["üéØ CLI Entry Points"]
        direction TB
        A[nik-cli.ts<br/>Primary CLI Class & Command Parser]:::entry
        B[index.ts<br/>Main Entry Point & Bootstrap]:::entry
        C[main-orchestrator.ts<br/>Core Orchestrator & Workflow Manager]:::entry
        D[register-agents.ts<br/>Agent Registry & Dynamic Loading]:::entry
        A --> B --> C --> D
    end

    %% Core Engine - Stable Green Theme
    subgraph core["üî® Core Engine"]
        direction TB
        E[AgentManager<br/>core/agent-manager.ts<br/>Agent Lifecycle & Dispatch]:::core
        F[ToolService<br/>services/tool-service.ts<br/>Tool Invocation & Validation]:::core
        G[PlanningService<br/>planning/enhanced-planning.ts<br/>Strategic Planning & Decomposition]:::core
        H[ConfigManager<br/>config/config-manager.ts<br/>Env, CLI & Runtime Config]:::core
        I[EventEmitter<br/>Global Events & Observability]:::core
        C -.-> E
        C -.-> F
        C -.-> G
        C -.-> H
        C -.-> I
    end

    %% Agents & Execution - Dynamic Purple/Orange
    subgraph agents["ü§ñ Agents & Execution Layer"]
        direction LR
        subgraph agentSub["Agents"]
            J[Universal Agent<br/>Multi-purpose Task Handler]:::agents
            K[React Expert Agent<br/>Frontend UI/UX Tasks]:::agents
            L[Code Reviewer Agent<br/>Quality & Best Practices]:::agents
            M[Backend Expert Agent<br/>API/Server Logic]:::agents
            N[Automation Agent<br/>Background & Scheduled Tasks]:::agents
        end
        subgraph execSub["Execution"]
            O[Core Tools<br/>read_file, write_file, execute_command]:::execution
            P[External Tools<br/>git, npm, docker via CLI]:::execution
            Q[Analysis Tools<br/>code_analysis, dependency_analysis]:::execution
            R[Todo Planner<br/>Step-by-Step Plans & Milestones]:::execution
            S[Risk Assessment<br/>policies/ - Threat Modeling]:::execution
            T[Approval System<br/>middleware/approval - Human-in-Loop]:::execution
            U[Execution Engine<br/>engine/ - Parallel/Serial Runs]:::execution
            V[VM Isolation<br/>Sandbox for Secure Tasks]:::execution
        end
        E --> agentSub
        F --> execSub
        G --> R --> S --> T --> U --> V
    end

    %% AI & Providers - Intelligent Pink
    subgraph ai["üß† AI & Providers"]
        direction TB
        W[AI Providers Hub<br/>ai/ - Unified Interface]:::ai
        X[Anthropic Claude<br/>Tool-calling, Streaming Responses]:::ai
        Y[OpenAI GPT<br/>Vision, Code Generation, Reasoning]:::ai
        Z[Google Gemini<br/>Multimodal Processing]:::ai
        AA[Local Ollama<br/>Offline & Privacy-Focused]:::ai
        C -.-> W
        W --> X & Y & Z & AA
        E -.-> W
        G -.-> W
    end

    %% Integrations & Services - Connected Green
    subgraph integrations["üîó Integrations & Services"]
        direction LR
        BB[Redis Cache<br/>core/token-cache.ts<br/>Tokens, Completions, Sessions]:::integrations
        CC[Supabase<br/>persistence/ - Auth, DB, Realtime Sync]:::integrations
        DD[MCP Plugins<br/>mcp/ - Model Context Protocol]:::integrations
        EE[Web3/Onchain<br/>onchain/ - Wallets, Smart Contracts]:::integrations
        FF[Docs Library<br/>context/ - doc_search, smart_docs]:::integrations
        GG[LSP/IDE Integrations<br/>lsp/ - Diagnostics, Auto-complete]:::integrations
        HH[Semantic Search<br/>context/semantic-search.ts - Embeddings]:::integrations
        C -.-> BB & CC & DD & EE & FF & GG & HH
    end

    %% UI & Persistence - User-Centric Yellow
    subgraph ui["üñ•Ô∏è UI & Persistence"]
        direction TB
        subgraph uiSub["UI Layer"]
            II[Chat UI<br/>chat/ - Interactive Terminal UI]:::ui
            JJ[Status Panels<br/>Real-time Metrics: Tokens, Costs, Progress]:::ui
            KK[Slash Commands<br/>/plan, /auto, /vm, /tokens]:::ui
            II --> JJ
            II --> KK
        end
        subgraph persistSub["Persistence"]
            LL[Token Cache<br/>core/token-cache.ts - LLM Outputs]:::persistence
            MM[Session Store<br/>store/ - Local/Cloud Sessions]:::persistence
            NN[Persistence Layer<br/>persistence/ - State Snapshots & Recovery]:::persistence
        end
        C -.-> II
        II -.-> C
        C -.-> LL & MM & NN
        CC <--> MM
        II <--> CC
    end

    %% Security & Middleware - Secure Red
    subgraph security["üõ°Ô∏è Security & Middleware"]
        direction TB
        OO[Middleware Pipeline<br/>auth, security, routing]:::security
        PP[Approval Workflows<br/>For High-Risk Operations]:::security
        QQ[Sandbox Policies<br/>policies/ - Compliance & Isolation]:::security
        RR[Dev/Safe Modes<br/>Error Handling & Fallbacks]:::security
        C --> OO --> PP & QQ & RR
        T -.-> OO
    end

    %% Data Flows - Dotted for Interactions
    J -.-> O
    K -.-> O
    L -.-> Q
    M -.-> P
    N -.-> U
    R -.-> J
    T -.-> O
    W -.-> E
    W -.-> G
    BB <--> C
    CC <--> II
    DD -.-> F
    EE -.-> U
    FF -.-> G
    GG -.-> II
    HH -.-> R
    LL -.-> W
    NN -.-> U

    %% Legend
    subgraph legend["üìã Legend"]
        direction TB
        leg1[üü¶ Entry/Core: Initialization Flow]:::legend
        leg2[üü™ Agents/Exec: Dynamic Processing]:::legend
        leg3[üü• AI: Intelligence Layer]:::legend
        leg4[üü© Integrations: External Services]:::legend
        leg5[üü® UI/Persist: User & State Mgmt]:::legend
        leg6[üü• Security: Protection Layer]:::legend
        leg7[Solid Arrow: Direct Dependency<br/>Dotted: Interaction/Call]:::legend
    end

    %% Professional Styling Definitions
    classDef entry fill:#E3F2FD,stroke:#1976D2,stroke-width:3px,color:#0D47A1,font-weight:bold
    classDef core fill:#E8F5E8,stroke:#388E3C,stroke-width:3px,color:#1B5E20,font-weight:bold
    classDef agents fill:#F3E5F5,stroke:#7B1FA2,stroke-width:3px,color:#4A148C,font-weight:bold
    classDef execution fill:#FFF3E0,stroke:#F57C00,stroke-width:3px,color:#E65100,font-weight:bold
    classDef ai fill:#FCE4EC,stroke:#C2185B,stroke-width:3px,color:#880E4F,font-weight:bold
    classDef integrations fill:#E8F5E8,stroke:#2E7D32,stroke-width:2px,stroke-dasharray: 5 5,color:#1B5E20
    classDef ui fill:#FFF8E1,stroke:#F57F17,stroke-width:3px,color:#E65100,font-weight:bold
    classDef persistence fill:#F5F5F5,stroke:#757575,stroke-width:2px,color:#212121
    classDef security fill:#FFEBEE,stroke:#D32F2F,stroke-width:4px,color:#B71C1C,font-weight:bold
    classDef legend fill:#FAFAFA,stroke:#9E9E9E,stroke-width:1px,color:#616161,font-size:12px

    %% Apply to title
    class title fill:#2196F3,stroke:#1976D2,stroke-width:2px,color:#FFFFFF