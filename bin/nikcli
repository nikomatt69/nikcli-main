#!/usr/bin/env bash
set -euo pipefail

# Resolve repo root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

BINARY_ENTRY="${ROOT_DIR}/dist/cli/nikcli"
SRC_ENTRY="${ROOT_DIR}/src/cli/index.ts"
TSCONFIG="${ROOT_DIR}/tsconfig.cli.json"

# Priority 1: Use compiled binary if available (standalone executable)
if [[ -f "$BINARY_ENTRY" ]]; then
  exec "$BINARY_ENTRY" "$@"
fi

# Priority 2: Use Bun to run TypeScript directly (Bun supports TS natively)
if command -v bun >/dev/null 2>&1; then
  exec bun --bun run "$SRC_ENTRY" "$@"
fi

# Priority 3: Fallback to Node.js with ts-node
if command -v npx >/dev/null 2>&1; then
  exec npx ts-node --project "$TSCONFIG" "$SRC_ENTRY" "$@"
fi

echo "NikCLI: build output not found and no runtime available."
echo "Options:"
echo "  1. Run: bun run build (to create binary)"
echo "  2. Install Bun: https://bun.sh"
echo "  3. Install Node.js and ts-node"
exit 1
