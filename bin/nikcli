#!/usr/bin/env bash
set -euo pipefail

# Resolve repo root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "${SCRIPT_DIR}/.." && pwd)"

DIST_ENTRY="${ROOT_DIR}/dist/cli/index.mjs"
SRC_ENTRY="${ROOT_DIR}/src/cli/index.ts"
TSCONFIG="${ROOT_DIR}/tsconfig.cli.json"

# Check if built file exists and execute with ESM support
if [[ -f "$DIST_ENTRY" ]]; then
  # .mjs extension tells Node.js to treat this as an ES module
  exec node "$DIST_ENTRY" "$@"
fi

# Fallback to ts-node for development (supports ESM with proper config)
if command -v npx >/dev/null 2>&1; then
  # ts-node with ESM support
  exec npx ts-node --esm --project "$TSCONFIG" "$SRC_ENTRY" "$@" 2>/dev/null || \
       exec npx ts-node --project "$TSCONFIG" "$SRC_ENTRY" "$@"
fi

echo "NikCLI: build output not found."
echo "Run: npm run build"
exit 1
