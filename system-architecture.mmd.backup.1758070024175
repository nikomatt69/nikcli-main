graph TD
    subgraph "CLI Entry Points"
        A[nik-cli.ts - Primary CLI Class] --> B[index.ts - Main Entry Point]
        B --> C[main-orchestrator.ts - Core Orchestrator]
        C --> D[register-agents.ts - Agent Registration]
    end

    subgraph "Core Engine"
        C --> E[AgentManager - core/agent-manager.ts]
        C --> F[ToolService - services/tool-service.ts]
        C --> G[PlanningService - planning/enhanced-planning.ts]
        C --> H[ConfigManager - config/config-manager.ts]
        C --> I[EventEmitter - Global Events]
    end

    subgraph "Agents & Execution"
        E --> J[Universal Agent - Multi-purpose]
        E --> K[React Expert Agent - Frontend Tasks]
        E --> L[Code Reviewer Agent - Quality Checks]
        E --> M[Backend Expert Agent - Server Logic]
        E --> N[Automation Agent - background-agents]
        
        F --> O[Core Tools: read_file, write_file, execute_command]
        F --> P[External Tools: git, npm, docker via commands/]
        F --> Q[Analysis Tools: code_analysis, dependency_analysis]
        
        G --> R[Todo Planner - Generates step-by-step plans]
        R --> S[Risk Assessment - policies/]
        S --> T[Approval System - middleware/approval]
        T --> U[Execution Engine - engine/]
        U --> V[VM Isolation - For sandboxed tasks]
    end

    subgraph "AI & Providers"
        C --> W[AI Providers - ai/]
        W --> X[Anthropic Claude - Tool-calling, Streaming]
        W --> Y[OpenAI GPT - Vision, Generation]
        W --> Z[Google Gemini - Multimodal]
        W --> AA[Local Ollama - Offline Mode]
        
        E --> W
        G --> W
    end

    subgraph "Integrations & Services"
        C --> BB[Redis Cache - core/token-cache.ts, Completion Cache]
        C --> CC[Supabase - persistence/ - Auth, Sessions, Sync]
        C --> DD[MCP Plugins - mcp/ - Model Context Protocol]
        C --> EE[Web3/Onchain - onchain/ - Coinbase Wallet, Transfers]
        C --> FF[Docs Library - context/ - doc_search, smart_docs]
        C --> GG[LSP/IDE - lsp/ - Diagnostics, Integrations]
        C --> HH[Semantic Search - context/semantic-search.ts]
    end

    subgraph "UI & Persistence"
        C --> II[Chat UI - chat/ - Slash Commands, History]
        II --> JJ[Status Panels - Real-time Metrics: Tokens, Costs]
        II --> KK[Slash Commands: /plan, /auto, /vm, /tokens]
        
        C --> LL[Token Cache - core/token-cache.ts]
        C --> MM[Session Store - store/ - Local/Cloud]
        C --> NN[Persistence Layer - persistence/ - Snapshots]
    end

    subgraph "Data Flows & Interactions"
        J -.-> O
        K -.-> O
        L -.-> Q
        M -.-> P
        N -.-> U
        
        R -.-> J
        T -.-> O
        W -.-> E
        W -.-> G
        
        BB <--> C
        CC <--> II
        DD <--> F
        EE <--> U
        FF <--> G
        GG <--> II
        HH <--> R
        
        II <--> C
        LL <--> W
        MM <--> CC
        NN <--> U
    end

    subgraph "Security & Middleware"
        C --> OO[Middleware - auth, security, routing]
        OO --> PP[Approval Workflows - For risky ops]
        OO --> QQ[Sandbox Policies - policies/]
        OO --> RR[Dev/Safe Modes]
    end

    style A fill:#e1f5fe
    style E fill:#f3e5f5
    style F fill:#e8f5e8
    style G fill:#fff3e0
    style W fill:#fce4ec
    style II fill:#f1f8e9
    style OO fill:#ffebee
