---
title: "Architecture Overview"
description: "Deep dive into NikCLI's modular architecture and component relationships"
icon: "cube"
---

# NikCLI Architecture Documentation

## System Overview

NikCLI is built with a **modular, layered architecture** designed for scalability, maintainability, and extensibility. The system is organized into clear functional layers that separate concerns while enabling seamless interaction between components.

## Directory Structure

```
nikcli-main/
├── src/cli/
│   ├── index.ts                    # Unified entry point (73KB)
│   ├── nik-cli.ts                  # Core CLI class (900KB) - main interactive session
│   ├── nikd.ts                     # Daemon process for background agents
│   ├── nikctl.ts                   # Control CLI for daemon management
│   ├── main-orchestrator.ts        # Main orchestrator for system initialization
│   ├── streaming-orchestrator.ts   # Real-time streaming interface
│   ├── unified-chat.ts             # Unified chat interface
│   ├── register-agents.ts          # Agent registration
│   │
│   ├── core/                       # Core modules (72+ files)
│   │   ├── agent-manager.ts        # Enterprise agent lifecycle management
│   │   ├── agent-factory.ts        # Agent instance factory
│   │   ├── config-manager.ts       # Centralized configuration (100KB+)
│   │   ├── tool-registry.ts        # Tool registration and routing
│   │   ├── tool-router.ts          # Intelligent tool routing (64KB)
│   │   ├── readline-manager.ts     # Readline interface singleton
│   │   ├── input-queue.ts          # Concurrent input handling
│   │   ├── context-manager.ts      # Context management
│   │   ├── context-token-manager.ts # Token tracking & optimization
│   │   ├── mcp-client.ts           # MCP protocol client
│   │   ├── plugin-manager.ts       # Plugin system
│   │   ├── logger.ts               # Logging infrastructure
│   │   └── ... (60+ more core modules)
│   │
│   ├── orchestrator/               # Orchestration layer (5 core files)
│   │   ├── context-orchestrator.ts     # Central context coordinator
│   │   ├── adaptive-context-optimizer.ts # Task complexity & slicing
│   │   ├── context-pattern-learner.ts   # Pattern learning & adaptation
│   │   ├── user-preference-manager.ts   # Persistent preferences
│   │   ├── parallel-task-context-manager.ts # Chain management
│   │   └── types/
│   │       └── orchestrator-types.ts    # Shared type definitions
│   │
│   ├── tools/                      # Tool system (75+ tools)
│   │   ├── index.ts                # Barrel file with all exports
│   │   ├── base-tool.ts            # Base tool class
│   │   ├── secure-file-tools.ts    # File operations (read, write, list)
│   │   ├── secure-command-tool.ts  # Sandboxed command execution
│   │   ├── git-tools.ts            # Git operations
│   │   ├── web-search-tool.ts      # DuckDuckGo search
│   │   ├── browserbase-tool.ts     # Web browsing automation
│   │   ├── figma-tool.ts           # Figma integration
│   │   ├── coinbase-agentkit-tool.ts # Blockchain operations
│   │   ├── vision-analysis-tool.ts  # AI image analysis
│   │   ├── image-generation-tool.ts # DALL-E image generation
│   │   ├── rag-search-tool.ts      # Semantic/RAG search
│   │   ├── memory-search-tool.ts   # Long-term memory search
│   │   ├── secure-tools-registry.ts # Secure tool execution layer
│   │   └── ... (60+ more tools)
│   │
│   ├── services/                   # Services layer (26+ files)
│   │   ├── tool-service.ts         # Tool execution service
│   │   ├── agent-service.ts        # Agent lifecycle (68KB)
│   │   ├── planning-service.ts     # AI planning coordination
│   │   ├── cache-service.ts        # Redis caching layer
│   │   ├── memory-service.ts       # Persistent AI memory
│   │   ├── streamtty-service.ts    # Streaming TTY operations
│   │   ├── auto-update-service.ts  # Version checking
│   │   ├── notification-service.ts # Multi-provider notifications
│   │   ├── lsp-service.ts          # Language Server Protocol
│   │   ├── background-agent-service.ts # Background job management
│   │   └── ... (16+ more services)
│   │
│   ├── context/                    # Context & RAG (17 files)
│   │   ├── rag-system.ts           # Unified RAG system
│   │   ├── semantic-search-engine.ts # Semantic search
│   │   ├── workspace-context.ts    # Project workspace context
│   │   ├── ai-sdk-embedding-provider.ts # Multi-provider embeddings
│   │   ├── unified-embedding-interface.ts # Standardized API
│   │   └── ... (12 more context files)
│   │
│   ├── ui/                         # UI components (28+ files)
│   │   ├── advanced-cli-ui.ts      # Central UI hub (2347 lines)
│   │   ├── approval-system.ts      # Approval workflows (2652 lines)
│   │   ├── theme-manager.ts        # Multi-theme system (1260 lines)
│   │   ├── fixed-prompt-manager.ts # Fixed prompt positioning
│   │   ├── terminal-output-manager.ts # Output tracking
│   │   ├── diff-manager.ts         # Git diff display
│   │   ├── visual-formatters.ts    # Stream/markdown formatting
│   │   ├── output-formatter.ts     # Structured output
│   │   └── ... (20+ more UI components)
│   │
│   ├── providers/                  # External providers
│   │   ├── supabase/               # Auth, database, enhanced provider
│   │   ├── redis/                  # Redis caching provider
│   │   ├── browserbase/            # Browser automation
│   │   ├── figma/                  # Figma integration
│   │   ├── cad-gcode/              # CAD/G-Code providers
│   │   └── ... (10+ more providers)
│   │
│   ├── automation/                 # Automation & agents
│   │   └── agents/
│   │       ├── universal-agent.ts  # Universal enterprise agent
│   │       ├── cognitive-agent-base.ts # Cognitive code generation
│   │       ├── autonomous-orchestrator.ts # Autonomous workflows
│   │       └── polymarket-agent.ts # Market-related tasks
│   │
│   ├── virtualized-agents/         # VM-based agents
│   │   └── secure-vm-agent.ts      # Isolated development agent
│   │
│   ├── background-agents/          # Background processing
│   │   ├── background-agent-service.ts
│   │   ├── services/
│   │   │   ├── chat-session-service.ts
│   │   │   └── ai-chat-service.ts
│   │   └── ... (5 more files)
│   │
│   ├── ai/                         # AI layer (16 files)
│   │   ├── advanced-ai-provider.ts # Main AI provider (228KB)
│   │   ├── modern-ai-provider.ts   # Streamlined provider (76KB)
│   │   ├── model-provider.ts       # Core model provider (36KB)
│   │   ├── adaptive-model-router.ts # Tier-based routing (37KB)
│   │   ├── provider-registry.ts    # AI SDK provider registry (20KB)
│   │   ├── reasoning-detector.ts   # Reasoning capability detection (25KB)
│   │   └── ... (10 more AI files)
│   │
│   ├── policies/                   # Security policies
│   │   └── execution-policy.ts     # Execution policy management
│   │
│   ├── tui/                        # Full TUI framework
│   │   ├── TUIApplication.ts       # Main TUI application
│   │   ├── core/                   # EventBus, TUIState, Navigation
│   │   ├── elements/               # UI elements (panels, specialized)
│   │   ├── layout/                 # Layout management
│   │   └── integration/            # Theme/Streamtty adapters
│   │
│   └── types/                      # Type definitions (24 files)
│       ├── types.ts                # Core type definitions
│       ├── agent.ts                # Agent-specific types
│       ├── orchestration.ts        # Orchestration types
│       ├── streaming.ts            # Streaming/message types
│       └── ... (20 more type files)
│
├── packages/docs/                  # Mintlify documentation
├── streamtty/                      # Streamtty library
├── web/                            # Web UI
├── api/                            # Serverless functions
├── tests/                          # Test files
├── scripts/                        # Build scripts
└── installer/                      # Installation scripts
```

## Architecture Layers

### Layer 1: Entry Points

**Files:** `index.ts`, `nik-cli.ts`, `nikd.ts`, `nikctl.ts`

The entry points handle system initialization and provide different execution modes:

- **index.ts** (73KB): Unified entry point that sets up global handlers, initializes all services, runs onboarding, and starts the `MainOrchestrator` which launches `NikCLI`

- **nik-cli.ts** (900KB): Core CLI class managing the interactive session with:
  - Readline interface for user input
  - Slash command processing
  - Multiple modes (default, plan, VM)
  - Tools integration
  - Chat UI rendering

- **nikd.ts**: Daemon process for background agents with API server

- **nikctl.ts**: Control CLI for daemon management

### Layer 2: Core Modules

**Directory:** `src/cli/core/` (72+ files)

Core modules provide foundational functionality:

| Module | Purpose |
|--------|---------|
| `agent-manager.ts` | Enterprise agent lifecycle, task queues, scheduling |
| `agent-factory.ts` | Agent instance creation with configurations |
| `config-manager.ts` | Centralized configuration (100KB+) |
| `tool-registry.ts` | Tool registration and discovery |
| `tool-router.ts` | Intelligent tool routing (64KB) |
| `context-manager.ts` | Context management for AI interactions |
| `input-queue.ts` | Concurrent input handling with bypass support |
| `readline-manager.ts` | Readline singleton preventing multiple instances |
| `mcp-client.ts` | Model Context Protocol integration |
| `plugin-manager.ts` | Plugin system for extensibility |

### Layer 3: Orchestration

**Directory:** `src/cli/orchestrator/` (5 core files)

The orchestration layer manages task execution and context:

```
ContextOrchestrator (Central Coordinator)
    ├── AdaptiveContextOptimizer → Task complexity calculation
    ├── ContextPatternLearner → Pattern learning & adaptation
    ├── UserPreferenceManager → Persistent preferences
    └── ParallelTaskContextManager → Chain & agent context management
```

**Key Classes:**

- `ContextOrchestrator`: Orchestrates tasks across multiple agents, manages dynamic token budgets (85% context / 15% output), calculates optimal agent counts

- `AdaptiveContextOptimizer`: Calculates task complexity (0-100 score) based on:
  - Code complexity (35% weight) - implementation/refactoring tasks
  - Dependency complexity (25% weight) - number of dependencies
  - Scope complexity (20% weight) - description length
  - Interdependency complexity (20% weight) - dependent tasks

- `ContextPatternLearner`: Learns from execution outcomes to improve future decisions, adjusts `maxContextTokens` and agent count

- `UserPreferenceManager`: Persists preferences to `~/.nikcli/user-preferences.json`

- `ParallelTaskContextManager`: Manages task chains and dependency-based execution waves

### Layer 4: AI Layer

**Directory:** `src/cli/ai/` (16 files)

The AI layer provides intelligent model selection and streaming:

| File | Size | Purpose |
|------|------|---------|
| `advanced-ai-provider.ts` | 228KB | Full autonomy streaming, 35+ tools |
| `modern-ai-provider.ts` | 76KB | Simplified provider, basic tools |
| `model-provider.ts` | 36KB | Core generation, routing, Zod validation |
| `adaptive-model-router.ts` | 37KB | Tier-based model selection |
| `provider-registry.ts` | 20KB | AI SDK provider registry |

**Supported Providers:**
- OpenAI (GPT-4/5)
- Anthropic (Claude)
- Google (Gemini)
- OpenRouter (200+ models)
- Groq, Cerebras, Vercel, xAI, Mistral
- Local: LlamaCpp, LM Studio, Ollama

### Layer 5: Tools System

**Directory:** `src/cli/tools/` (75+ tools)

Organized into categories:

| Category | Tools |
|----------|-------|
| **File Operations** | ReadFileTool, WriteFileTool, ListDirectoryTool, ReplaceInFileTool, MultiReadTool, JsonPatchTool |
| **Search** | GrepTool, GlobTool, FindFilesTool, RAGSearchTool |
| **Command Execution** | SecureCommandTool, BashTool, RunCommandTool |
| **Git** | GitTools (status, diff, commit, branch) |
| **Web** | WebSearchTool (DuckDuckGo), BrowserbaseTool |
| **AI/ML** | VisionAnalysisTool, ImageGenerationTool, MemorySearchTool |
| **Design** | FigmaTool (API + v0 integration) |
| **Blockchain** | CoinbaseAgentKitTool, GoatTool |
| **Utility** | DiffTool, TreeTool, WatchTool, TodoTools |

**Security Levels:**
- `safe`: File reading, code analysis, search
- `confirmed`: File writing, Git operations (requires approval)
- `dangerous`: File deletion, system commands (explicit approval)

### Layer 6: Services

**Directory:** `src/cli/services/` (26+ files)

Services provide business logic and integrations:

| Service | Purpose |
|---------|---------|
| `tool-service.ts` | Tool execution with security checks |
| `agent-service.ts` | Agent lifecycle and task management (68KB) |
| `planning-service.ts` | AI planning coordination |
| `cache-service.ts` | Redis caching with SmartCache fallback |
| `memory-service.ts` | Persistent AI memory via mem0 |
| `streamtty-service.ts` | Terminal streaming output |
| `auto-update-service.ts` | Version checking and updates |
| `notification-service.ts` | Slack, Discord, Linear notifications |
| `background-agent-service.ts` | Background job management |
| `taskmaster-service.ts` | TaskMaster AI integration |

### Layer 7: Context & RAG

**Directory:** `src/cli/context/` (17 files)

Provides workspace understanding:

- `rag-system.ts`: Unified RAG with vector, workspace, and BM25 search
- `semantic-search-engine.ts`: Advanced query understanding
- `ai-sdk-embedding-provider.ts`: Multi-provider embeddings (OpenAI, Google, OpenRouter)
- `workspace-context.ts`: Project structure analysis

### Layer 8: UI Components

**Directory:** `src/cli/ui/` (28+ files)

| Component | Purpose |
|-----------|---------|
| `advanced-cli-ui.ts` | Central UI hub (2347 lines) |
| `approval-system.ts` | Approval workflows (2652 lines) |
| `theme-manager.ts` | Multi-theme system (11 themes, 3 modes each) |
| `fixed-prompt-manager.ts` | Fixed prompt positioning via ANSI scroll regions |
| `terminal-output-manager.ts` | Output tracking and cleanup |
| `visual-formatters.ts` | Markdown/code formatting |
| `token-aware-status-bar.ts` | Real-time token display |

## Data Flow

```
User Input (CLI)
    │
    v
ReadlineManager → InputQueue
    │
    v
NikCLI (Main Session)
    │
    ├──→ AgentManager → UniversalAgent / VM Agent / CognitiveAgent
    │           │
    │           └──→ ToolRegistry → SecureToolsRegistry
    │
    ├──→ ContextOrchestrator
    │           │
    │           ├──→ AdaptiveContextOptimizer (complexity calculation)
    │           ├──→ ParallelTaskContextManager (chain management)
    │           └──→ ContextPatternLearner (learning)
    │
    ├──→ ModelProvider → AdvancedAIProvider → AI SDK (streamText)
    │
    └──→ StreamttyService → Terminal Output
```

## Key Design Patterns

1. **Singleton Services**: `toolService`, `agentService`, `cacheService` use singleton pattern
2. **EventEmitter**: Orchestrators and managers extend EventEmitter for async communication
3. **Policy-Based Security**: `ExecutionPolicyManager` evaluates operations before execution
4. **Bypass Pattern**: `inputQueue.enableBypass()` / `disableBypass()` for approval prompts
5. **Adaptive Budgeting**: Token budgets adjust based on recent usage patterns (85/15 split)
6. **Plugin System**: Extensible via `plugin-manager.ts` and `plugin-registry.ts`
7. **Context Slices**: Parallel agents receive optimized context slices

## Configuration

### Environment Variables

```bash
# AI Providers
ANTHROPIC_API_KEY, OPENAI_API_KEY, GOOGLE_GENERATIVE_AI_API_KEY, OPENROUTER_API_KEY

# Redis Caching
UPSTASH_REDIS_REST_URL, UPSTASH_REDIS_REST_TOKEN

# Vector Database
UPSTASH_VECTOR_REST_URL, UPSTASH_VECTOR_REST_TOKEN

# Features
NIKCLI_CLEAN_CHAT=1  # Minimal output mode
NIKCLI_QUIET_STARTUP=1  # Suppress startup logs
```

### Configuration Files

- `~/.nikcli/config.json` - User configuration
- `~/.nikcli/user-preferences.json` - Persisted preferences
- `~/.nikcli/vector-cache/` - Embedding cache
- `~/.nikcli/guidance/` - Project-specific guidance files

## Performance Characteristics

- **Startup**: ~500ms (quiet mode) to ~2s (full initialization)
- **Streaming Latency**: <100ms for first token
- **Tool Execution**: Variable (file ops ~10ms, web search ~500ms)
- **Context Budget**: Dynamic (default 200K tokens, adjustable 10K-1M)
- **Caching**: Redis for distributed, local cache for fallback
